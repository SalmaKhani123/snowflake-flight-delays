# Analysis Log — 2025-09-12

**Note:** To avoid type quirks, all queries read from the raw table
`flight_project.flight_project_raw.flights`. We treat `CANCELLED` as 0/1.

## Monthly trend of arrival delay (exclude cancelled)
```sql
SELECT
  DATE_TRUNC('month', FL_DATE) AS month,
  ROUND(AVG(IFF(CANCELLED = 1, NULL, ARR_DELAY)), 2) AS avg_arr_delay,
  COUNT(IFF(CANCELLED = 0 AND ARR_DELAY IS NOT NULL, 1, NULL)) AS flights_count
FROM flight_project.flight_project_raw.flights
GROUP BY month
ORDER BY month;

Cancellation rate by airline

SELECT
  OP_CARRIER,
  ROUND(100.0 * AVG(IFF(CANCELLED = 1, 1, 0)), 2) AS cancel_rate_pct,
  COUNT(*) AS total_flights
FROM flight_project.flight_project_raw.flights
GROUP BY OP_CARRIER
HAVING COUNT(*) >= 100
ORDER BY cancel_rate_pct DESC;

Worst routes by avg arrival delay (exclude cancelled; min 100)

SELECT
  ORIGIN, DEST,
  COUNT(*) AS flights,
  ROUND(AVG(IFF(CANCELLED = 1, NULL, ARR_DELAY)), 2) AS avg_arr_delay
FROM flight_project.flight_project_raw.flights
GROUP BY ORIGIN, DEST
HAVING COUNT(*) >= 100
   AND AVG(IFF(CANCELLED = 1, NULL, ARR_DELAY)) IS NOT NULL
ORDER BY avg_arr_delay DESC
LIMIT 20;

Per-airline KPIs (arrival excl cancelled; dep = all valid)

SELECT 
  OP_CARRIER,
  ROUND(AVG(IFF(CANCELLED = 1, NULL, ARR_DELAY)), 2) AS avg_arr_delay,
  ROUND(AVG(DEP_DELAY), 2)                           AS avg_dep_delay,
  COUNT(*)                                           AS rows_total,
  COUNT(IFF(CANCELLED = 0 AND ARR_DELAY IS NOT NULL, 1, NULL)) AS valid_arrivals,
  COUNT(DEP_DELAY)                                   AS valid_departures
FROM flight_project.flight_project_raw.flights
GROUP BY OP_CARRIER
HAVING COUNT(DEP_DELAY) > 0
ORDER BY avg_arr_delay DESC NULLS LAST;

On-time arrival (A15) by airline (completed = ARR_DELAY IS NOT NULL)

SELECT
  OP_CARRIER,
  COUNT_IF(ARR_DELAY IS NOT NULL)                             AS completed_flights,
  COUNT_IF(ARR_DELAY IS NOT NULL AND ARR_DELAY <= 15)         AS ontime_flights,
  ROUND(100.0 * COUNT_IF(ARR_DELAY IS NOT NULL AND ARR_DELAY <= 15)
        / NULLIF(COUNT_IF(ARR_DELAY IS NOT NULL), 0), 2)      AS on_time_arrival_pct
FROM flight_project.flight_project_raw.flights
GROUP BY OP_CARRIER
ORDER BY on_time_arrival_pct DESC;
Notes: Delay averages exclude cancelled flights; cancellation is reported separately.

## Findings (from my run)
- Overall on-time (A15): **0.34%**
- Note: This very low value suggests ARR_DELAY isn’t cleaned/mapped yet (many values > 15). I’ll fix the mapping later; for now I’m logging the result transparently.
